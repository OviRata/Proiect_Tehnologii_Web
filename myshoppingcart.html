<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <title>Web Garden</title>
  <meta name="description" content="">
  <link rel="stylesheet" href="resources/css/style.css">
  <link rel="stylesheet" href="resources/css/menustyle.css">
  <link rel="stylesheet" href="resources/css/shoppingcart.css">


  <script src="./resources/js/role.js"></script>
  <script src="./resources/js/config.js"></script>
  <script src="./resources/js/urlHelper.js"></script>
  <script src="./resources/js/app.js"></script>
  <script src="./resources/js/menuByRole.js"></script>

  <script src="./resources/js/shoppingCart.js"></script>

</head>

<body>



<div class="flex-wrapper">
  <div class="mainmenu">
    <a href="index.html" class="logo" id="home">
      Bloom Buddy</a>
    <div class="navbar-desktop">
      <li class="nav-item" id="list-search1"> <a href="#" id="search1">Search</a></li>
      <li class="nav-item" id="list-mygarden1"><a href="#" id="mygarden1">My garden</a></li>
      <li class="nav-item" id="list-mycart1"><a href="#" id="mycart1">My shopping cart</a></li>
      <li class="nav-item" id="list-myAccount1"><a href="#" id="myAccount1">My account</a></li>
    </div>

    <button class="navbar-toggler" id="navbar-toggler">
      <span></span>
      <span></span>
      <span></span>
    </button>




    <script src="./resources/js/navbar-script.js"></script>
  </div>
  <div class="navbar-menu" id="navbar-menu">
    <ul class="navbar-nav" id = "navbar-nav">
      <li class="nav-item" id="list-search"> <a href="#" id="search">Search</a></li>
      <li class="nav-item" id="list-mygarden"><a href="#" id="mygarden">My garden</a></li>
      <li class="nav-item" id="list-mycart"><a href="#" id="mycart">My shopping cart</a></li>
      <li class="nav-item" id="list-myAccount"><a href="#" id="myAccount">My account</a></li>
    </ul>
  </div>


  <div class="mainTitle">
    Shopping cart
  </div>
  <div class="shopping-cart">
  </div>
  <div class="checkout-section">
    <div class="total-cost">
      Total Cost: <span id="total-cost-value"></span>
    </div>
    <button id="continue-to-payment">Continue to Payment</button>
  </div>
</div>


<script>
  initializeAll();
</script>
<script>
  document.addEventListener('DOMContentLoaded', () => {
    const continueToPaymentButton = document.getElementById('continue-to-payment');

    continueToPaymentButton.addEventListener('click', async () => {
      try {
        const userEmail = localStorage.getItem("globalEmail");
        const cartProductsCount = JSON.parse(localStorage.getItem("cartProductsCount"));
        const cartProds = JSON.parse(localStorage.getItem("cartProducts"));
        const productsJson = cartProds.map(product => {
          return {
            name: product.name,
            price: product.price
          };
        });

        const productsWithQuantity = productsJson.map((product, index) => {
          return {
            ...product,
            quantity: cartProductsCount[index] || 0
          };
        });

        if (!productsJson || !userEmail || !productsWithQuantity) {
          throw new Error('Products or user email not found.');
        }

        const token = localStorage.getItem("accessToken");
        const response = await fetch('/sendorderdetails', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'authorization': 'Bearer '+token
          },
          body: JSON.stringify({
            productsWithQuantity,
            userEmail
          })
        });

        if (!response.ok) {
          throw new Error('Failed to send order details.');
        }
        const responseData = await response.json();
        console.log('Order details sent:', responseData);

        localStorage.setItem("cartProducts", JSON.stringify([]));
        localStorage.setItem("cartProductsCount", JSON.stringify([]));

        window.location.href = '/placeOrder.html';
      } catch (error) {
        console.error('Error:', error.message);
        alert('Error: Failed to send order details. Please try again later.');
      }
    });
  });

</script>
<script>
  hideForRole(globalRole);
</script>




</body>
</html>

